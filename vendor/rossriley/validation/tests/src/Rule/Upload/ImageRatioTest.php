<?php

namespace Sirius\Validation\Rule\Upload;

class ImageRatioTest extends \PHPUnit_Framework_TestCase
{

    function setUp()
    {
        $this->validator = new ImageRatio(array('ratio' => 1));
    }

    function testMissingFiles()
    {
        $fileName = 'file_that_does_not_exist.gif';
        $file = array(
            'name' => $fileName,
            'type' => 'not_required',
            'size' => 'not_required',
            'tmp_name' => realpath(__DIR__ . '/../../../fixitures/') . DIRECTORY_SEPARATOR . $fileName,
            'error' => UPLOAD_ERR_OK
        );
        $this->assertFalse($this->validator->validate($file));
    }

    function testSquare()
    {
        $fileName = 'square_image.gif';
        $file = array(
            'name' => $fileName,
            'type' => 'not_required',
            'size' => 'not_required',
            'tmp_name' => realpath(__DIR__ . '/../../../fixitures/') . DIRECTORY_SEPARATOR . $fileName,
            'error' => UPLOAD_ERR_OK
        );
        $this->assertTrue($this->validator->validate($file));
    }

    function testAlmostSquare()
    {
        $fileName = 'almost_square_image.gif';
        $file = array(
            'name' => $fileName,
            'type' => 'not_required',
            'size' => 'not_required',
            'tmp_name' => realpath(__DIR__ . '/../../../fixitures/') . DIRECTORY_SEPARATOR . $fileName,
            'error' => UPLOAD_ERR_OK
        );
        $this->assertFalse($this->validator->validate($file));

        // change the error margin
        $this->validator->setOption(ImageRatio::OPTION_ERROR_MARGIN, 0.2);
        $this->assertTrue($this->validator->validate($file));
    }

    function testRatioZero()
    {
        $this->validator->setOption(ImageRatio::OPTION_RATIO, 0);
        $fileName = 'almost_square_image.gif';
        $file = array(
            'name' => $fileName,
            'type' => 'not_required',
            'size' => 'not_required',
            'tmp_name' => realpath(__DIR__ . '/../../../fixitures/') . DIRECTORY_SEPARATOR . $fileName,
            'error' => UPLOAD_ERR_OK
        );
        $this->assertTrue($this->validator->validate($file));
    }

    function testInvalidRatio()
    {
        $this->validator->setOption(ImageRatio::OPTION_RATIO, 'abc');
        $fileName = 'almost_square_image.gif';
        $file = array(
            'name' => $fileName,
            'type' => 'not_required',
            'size' => 'not_required',
            'tmp_name' => realpath(__DIR__ . '/../../../fixitures/') . DIRECTORY_SEPARATOR . $fileName,
            'error' => UPLOAD_ERR_OK
        );
        $this->assertTrue($this->validator->validate($file));
    }

    function testRatioAsString()
    {
        $this->validator->setOption(ImageRatio::OPTION_RATIO, '4:3');
        $fileName = '4_by_3_image.jpg';
        $file = array(
            'name' => $fileName,
            'type' => 'not_required',
            'size' => 'not_required',
            'tmp_name' => realpath(__DIR__ . '/../../../fixitures/') . DIRECTORY_SEPARATOR . $fileName,
            'error' => UPLOAD_ERR_OK
        );
        $this->assertTrue($this->validator->validate($file));
    }

}
